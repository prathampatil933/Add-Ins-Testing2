<!DOCTYPE html>
<html>

<head>
    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        .container {
            margin: 20px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
        }

        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        #sendButton {
            padding: 10px 20px;
            background-color: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #sendButton:hover {
            background-color: #005a9e;
        }

        #successMessage {
            color: green;
            font-weight: bold;
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>Send Message</h2>
        <div class="form-group">
            <label for="recipientEmail">Recipient Email:</label>
            <input type="text" id="recipientEmail" placeholder="Enter recipient's email...">
        </div>
        <div class="form-group">
            <label for="messageInput">Message:</label>
            <textarea id="messageInput" rows="4" cols="50" placeholder="Enter your message..."></textarea>
        </div>
        <button id="sendButton">Send Message</button>
        <span id="successMessage">Message sent successfully!</span>
    </div>

    <!-- The following image URL tracks diagnostic data for this sample add-in. Please remove the image tag if you reuse this sample in your own code project. -->
    <img src="https://pnptelemetry.azurewebsites.net/pnp-officeaddins/samples/outlook-add-in-hello-world-run" />
</body>

<script>

    Office.onReady((info) => {
        if (info.host === Office.HostType.Outlook) {
            document.getElementById("sendButton").onclick = sendMessage;
        }
    });

    /**
     * Sends the message to the specified recipient on Teams.
     */
    function sendMessage() {
        const recipientEmail = document.getElementById("recipientEmail").value;
        const message = document.getElementById("messageInput").value;

        // Check if recipient email and message are provided
        if (recipientEmail && message) {
            // Make a request to your server-side component to obtain the access token
            $.ajax({
                url: "https://your-server-url.com/get-access-token",
                type: "GET",
                success: function(response) {
                    // Use the obtained access token to send the message to the recipient on Teams
                    sendTeamsMessage(recipientEmail, message, response.access_token);
                },
                error: function(error) {
                    console.error('Error obtaining access token:', error);
                    alert("Error obtaining access token. Please try again.");
                }
            });
        } else {
            alert("Please provide recipient's email and message to send.");
        }
    }

    /**
     * Sends the message to the recipient on Teams using the obtained access token.
     */
    function sendTeamsMessage(recipientEmail, message, accessToken) {
        // Make a request to Microsoft Graph API to send the message
        $.ajax({
            url: "https://graph.microsoft.com/v1.0/users/" + recipientEmail + "/teamwork/sendActivityNotification",
            type: "POST",
            headers: {
                "Authorization": "Bearer " + accessToken,
                "Content-Type": "application/json"
            },
            data: JSON.stringify({
                "topic": {
                    "source": "text",
                    "value": message
                }
            }),
            success: function(response) {
                // Display success message and disable the send button
                document.getElementById("successMessage").style.display = "inline";
                document.getElementById("sendButton").disabled = true;
            },
            error: function(error) {
                console.error('Error sending message:', error);
                alert("Error sending message. Please try again.");
            }
        });
    }

</script>

</html>
